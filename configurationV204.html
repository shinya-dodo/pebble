<!DOCTYPE html>
<html>
  <head>
    <title>Configuration</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css" />
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
    <script src="analytics.js"></script>
  </head>
  <body>
    <div data-role="page" id="main">
      <div data-role="header" class="jqm-header">
        <h1>Configuration</h1>
      </div>

      <div data-role="content">

<fieldset data-role="controlgroup" data-type="horizontal" data-mini="true">
    <legend>BackGround Color:</legend>
        <label for="black">Black</label>
		<input type="radio" id="black" name="bgcolor" value="1" data-theme="c"/>
		
		<label for="white">White</label>
		<input type="radio" id="white" name="bgcolor" value="2" data-theme="c"/>
		
		<label for="color">Color</label>
		<input type="radio" id="color" name="bgcolor" value="3" data-theme="c" checked="checked"/>
</fieldset>

<fieldset data-role="controlgroup" data-type="horizontal" data-mini="true">
    <legend>Start of Week:</legend>
        <input name="week" id="sunday" value="0" checked="checked" type="radio">
        <label for="sunday">Sun</label>
        <input name="week" id="monday" value="1" type="radio">
        <label for="monday">Mon</label>
</fieldset>

<fieldset id="DateFormat" data-role="controlgroup" data-type="horizontal" data-mini="true">
    <legend>Date Format:</legend>
    <select name="ddlDate1" id="ddlDate1">
		<option value="Y" selected>YYYY</option>
		<option value="m">MM</option>
		<option value="d">DD</option>
		<option value="G">GGYY</option>
		<option value=""></option>
	</select>
	<select name="ddlDate2" id="ddlDate2">
		<option value="/" selected>/</option>
		<option value="-">-</option>
		<option value=".">.</option>
		<option value=""></option>
	</select>
	<select name="ddlDate3" id="ddlDate3">
		<option value="Y">YYYY</option>
		<option value="m" selected>MM</option>
		<option value="d">DD</option>
	</select>
	<select name="ddlDate4" id="ddlDate4">
		<option value="/" selected>/</option>
		<option value="-">-</option>
		<option value=".">.</option>
		<option value=""></option>
	</select>
	<select name="ddlDate5" id="ddlDate5">
		<option value="Y">YYYY</option>
		<option value="m">MM</option>
		<option value="d" selected>DD</option>
		<option value=""></option>
	</select>
</fieldset>
<fieldset data-role="controlgroup" data-mini="true">	
    <legend><h4>Days of Week:</h4></legend>
    <div class="ui-field-contain">
      <label for="keySun">Sunday:</label>
      <input name="keySun" id="txtSun" value="Su" data-mini="true" type="text" maxlength="2">
    </div>
    <div class="ui-field-contain">
      <label for="keyMon" >Monday:</label>
      <input name="keyMon" id="txtMon" value="Mo" data-mini="true" type="text" maxlength="2">
    </div>
    <div class="ui-field-contain">
      <label for="keyTue">Tuesday:</label>
      <input name="keyTue" id="txtTue" value="Tu" data-mini="true" type="text" maxlength="2">
    </div>	
    <div class="ui-field-contain">
      <label for="keyWed">Wednesday:</label>
      <input name="keyWed" id="txtWed" value="We" data-mini="true" type="text" maxlength="2">
    </div>
    <div class="ui-field-contain">
      <label for="keyThu">Thursday:</label>
      <input name="keyThu" id="txtThu" value="Th" data-mini="true" type="text" maxlength="2">
    </div>
    <div class="ui-field-contain">
      <label for="keyFri">Friday:</label>
      <input name="keyFri" id="txtFri" value="Fr" data-mini="true" type="text" maxlength="2">
    </div>
    <div class="ui-field-contain">
      <label for="keySat">Saturday:</label>
      <input name="keySat" id="txtSat" value="Sa" data-mini="true" type="text" maxlength="2">
    </div>
</fieldset>
    </div>

<br />
	<div class="ui-body ui-body-c">
		<fieldset class="ui-grid-a">
			<div class="ui-block-a">
				<button type="submit" data-theme="d" id="btnCancel">Cancel</button>
			</div>
			<div class="ui-block-b">
				<button type="submit" data-theme="b" id="btnSubmit">Submit</button>
			</div>
		</fieldset>
	</div>
</div>
    <script>
		function saveOptions()
		{
			var df = $("#ddlDate1").val() +
					 $("#ddlDate2").val() +
					 $("#ddlDate3").val() +
					 $("#ddlDate4").val() +
					 $("#ddlDate5").val();
			var options =
			{
				"bgcolor": parseInt($("input:radio[name=bgcolor]:checked").val()),
				"week": parseInt($("input:radio[name=week]:checked").val()),
				"dateformat": df,
				"keySun": $("#txtSun").val(), 
				"keyMon": $("#txtMon").val(), 
				"keyTue": $("#txtTue").val(), 
				"keyWed": $("#txtWed").val(), 
				"keyThu": $("#txtThu").val(), 
				"keyFri": $("#txtFri").val(), 
				"keySat": $("#txtSat").val()
			}
			return options;
		}
		
		$().ready(function()
		{
			//localStorageにあれば読み込み
			if (typeof window.localStorage !== "undefined") {
				if (window.localStorage.pebble_DateTimeCalendar2_options) 
				{
					ls_pto = JSON.parse(window.localStorage.pebble_DateTimeCalendar2_options);
					
		  			$("input[name=bgcolor][value=" +ls_pto["bgcolor"] + "]").prop('checked',true);
		  			$("input[name=bgcolor]").checkboxradio('refresh');	
		  			
		  			$("input[name=week][value=" +ls_pto["week"] + "]").prop('checked',true);
		  			$("input[name=week]").checkboxradio('refresh');	
		  			
		  			if('dateformat' in ls_pto)
		  			{
		  				$("#ddlDate1").val(ls_pto["dateformat"].substr(0, 1));
		  				$("#ddlDate2").val(ls_pto["dateformat"].substr(1, 1));
		  				$("#ddlDate3").val(ls_pto["dateformat"].substr(2, 1));
		  				$("#ddlDate4").val(ls_pto["dateformat"].substr(3, 1));
		  				$("#ddlDate5").val(ls_pto["dateformat"].substr(4, 1));
		  				$("#ddlDate1").selectmenu('refresh');
		  				$("#ddlDate2").selectmenu('refresh');
		  				$("#ddlDate3").selectmenu('refresh');
		  				$("#ddlDate4").selectmenu('refresh');
		  				$("#ddlDate5").selectmenu('refresh');
		  			}
		  			if('keySun' in ls_pto)
		  			{
		  				$("#txtSun").val(ls_pto["keySun"]);
		  				$("#txtMon").val(ls_pto["keyMon"]);
		  				$("#txtTue").val(ls_pto["keyTue"]);
		  				$("#txtWed").val(ls_pto["keyWed"]);
		  				$("#txtThu").val(ls_pto["keyThu"]);
		  				$("#txtFri").val(ls_pto["keyFri"]);
		  				$("#txtSat").val(ls_pto["keySat"]);
		  			}
		  		}
		  	}
		  	
			$("#btnCancel").click(function()
			{
				location.href = getQueryParam("return_to", "pebblejs://close#");
			});
			$("#btnSubmit").click(function()
			{
				ls_pto = JSON.stringify(saveOptions());
				//localStorageに保存
	          		if (typeof window.localStorage !== "undefined") 
	          		{
					window.localStorage.pebble_DateTimeCalendar2_options = ls_pto;
				}
				
				var return_to = getQueryParam("return_to", "pebblejs://close#");
				
				location.href = return_to + base64.encodeStringAsUTF8(ls_pto);
			});
			if(getQueryVariable("color") == "0")
			{
				if($("#color").prop('checked'))
				{
					$("#color").prop("checked", false);
					$("#black").prop("checked", true);
					
				}
				$("#color").prop("disabled", true);
				$("input[name=bgcolor]").checkboxradio('refresh');
			}
		});
		function getQueryVariable(variable)
		{
			var query = location.search.substring(1);
			var vars = query.split('&');
			for(var i = 0; i < vars.length; i++)
			{
				var pair = vars[i].split('=');
				if(pair[0] == variable)
				{
					return decodeURIComponent(pair[1]);
				}
			}
			return false;
		}
		// Something like this to get query variables.
		function getQueryParam(variable, default_) {
		    var query = location.search.substring(1);
		    var vars = query.split('&');
		    for (var i = 0; i < vars.length; i++) {
		        var pair = vars[i].split('=');
		        if (pair[0] == variable)
		            return decodeURIComponent(pair[1]);
		    }
		    return default_ || false;
		}
		/**
 * Base64 encoding
 * http://www.ietf.org/rfc/rfc2045.txt
 */

var Base64 = function() {
	this.initialize();
};

Base64.prototype.initialize = function() {
	this.symbols = [];
	var startChar = "A".charCodeAt(0);
	for(var i = 0; i < 26; i++) {
		this.symbols.push(String.fromCharCode(startChar + i));
	}
	var startChar = "a".charCodeAt(0);
	for(var i = 0; i < 26; i++) {
		this.symbols.push(String.fromCharCode(startChar + i));
	}
	var startChar = "0".charCodeAt(0);
	for(var i = 0; i < 10; i++) {
		this.symbols.push(String.fromCharCode(startChar + i));
	}
	this.symbols.push("+", "/");
	
	this.encodeMap = [];
	for(var i = 0; i < this.symbols.length; i++) {
		this.encodeMap[i] = this.symbols[i];
	}
	
	this.decodeMap = [];
	for(var i = 0; i < this.symbols.length; i++) {
		this.decodeMap[this.symbols[i]] = i;
	}
	this.decodeMap["="] = null;
};

	Base64.prototype.encode = function(octets) 
	{
		var i;
		var map = this.encodeMap;
		var encoded = [];
		for (i = 0, len = Math.floor(octets.length / 3) * 3;
			i < len; i += 3) {
			var b0 = octets[i];
			var b1 = octets[i + 1];
			var b2 = octets[i + 2];
			var qs = map[(b0 >> 2) & 0x3f] 
		  				+ map[((b0 << 4) + (b1 >> 4)) & 0x3f]
		  				+ map[((b1 << 2) + (b2 >> 6)) & 0x3f]
		  				+ map[b2 & 0x3f];
			encoded.push(qs);
		}
	
		switch(octets.length % 3) {
			case 1:
				var b0 = octets[i];
				var qs = map[(b0 >> 2) & 0x3f] 
				       + map[(b0 << 4) & 0x3f]
							 + "=="; 
				encoded.push(qs);
				break;
			case 2:
				var b0 = octets[i];
			  var b1 = octets[i + 1];			
				var qs = map[(b0 >> 2) & 0x3f] 
							 + map[((b0 << 4) + (b1 >> 4)) & 0x3f] 
							 + map[(b1 << 2) & 0x3f] 
							 + "=";
				encoded.push(qs);
			  break;
		}
		
		return encoded.join("");
	};

	Base64.prototype.decode = function(encoded) 
	{
		if(encoded.length % 4 != 0) 
		{
			throw "encoded.length must be a multiple of 4.";
		}
		
		var decoded = [];
		var map = this.decodeMap;
		for (var i = 0, len = encoded.length; i < len; i += 4) 
		{
			var b0 = map[encoded[i]];
			var b1 = map[encoded[i + 1]];
			var b2 = map[encoded[i + 2]];
			var b3 = map[encoded[i + 3]];
			
			var d0 = ((b0 << 2) + (b1 >> 4)) & 0xff;
			decoded.push(d0);
			
			if(b2 == null) break; // encoded[i + 1] == "="
			
			var d1 = ((b1 << 4) + (b2 >> 2)) & 0xff;
			decoded.push(d1);
			
			if(b3 == null) break; // encoded[i + 2] == "="
			
			var d2 = ((b2 << 6) + b3) & 0xff;
			decoded.push(d2);
			
		}
	
		return decoded;
	};

	Base64.prototype.uriEncodedToOctets = function(uriEncoded) 
	{
		var octets = [];
		for(var i = 0, len = uriEncoded.length; i < len; i++) 
		{
			// Note that IE6 doesn't allow an expression like "uriEncoded[i]";
			var c = uriEncoded.charAt(i);
			var b;
			if (c == "%") 
			{
				var hex = uriEncoded.charAt(++i) + uriEncoded.charAt(++i);
				b = parseInt(hex, 16);
			} 
			else 
			{
				b = c.charCodeAt(0);
			}
			octets.push(b);
  		}
		return octets;
	};

	Base64.prototype.encodeStringAsUTF8 = function(utf8str) 
	{
		var uriEncoded = encodeURIComponent(utf8str);
		var octets = this.uriEncodedToOctets(uriEncoded);
		return this.encode(octets);
	};

	Base64.prototype.octetsToUriEncoded = function(octets) 
	{
		var uriEncoded = [];
	
		for(var i = 0, len = octets.length; i < len; i++) 
		{
			var hex = octets[i].toString(16);
			hex = ("0" + hex).substr(hex.length - 1, 2);
			uriEncoded.push("%" + hex);
  		}
		return uriEncoded.join("");
	};

	Base64.prototype.decodeStringAsUTF8 = function(encoded) 
	{
		var octets = this.decode(encoded);
		var uriEncoded = this.octetsToUriEncoded(octets);
		return 	decodeURIComponent(uriEncoded);
	};

	var base64 = new Base64();
    </script>
  </body>
</html>
